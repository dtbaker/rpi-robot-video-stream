<!doctype html>
<html>
<head>
	<title>Robot Cam</title>
	<style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      .wrapper { display: none; }
      .loading { display: none; }
      .video { flex: 0 0 640px; background: #efefef }
	</style>
	<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div class="start" id="startWrapper">
	<button onclick="startThisThing()">Connect!</button>
</div>
<div class="loading" id="loadingWrapper">
	Waiting for robot to start......
</div>
<div class="wrapper" id="videoWrapper">
	<div class="video">
		<video src="" width="640" height="480" id="videoStream"></video>
	</div>
	<div class="sidebar">
		<p>
			People Connected: <span id="clientCount">0</span>
		</p>
		<div class="controls">
			<button onclick="move('forward');">Forward</button>
			<button onclick="move('back');">Back</button>
			<button onclick="move('left');">Left</button>
			<button onclick="move('right');">Right</button>
		</div>
	</div>
</div>
<script>
  var codecString = 'video/mp4; codecs="avc1.42C028"';
  var videoDom = document.getElementById('videoStream');
  var mediaSource = new MediaSource();
  videoDom.src = window.URL.createObjectURL(mediaSource);
  var buffer = null;
  var latestBufferData = [];
  var receivedFrames = false
  function updateBuffer(){
    if (latestBufferData.length > 0 && !buffer.updating && !videoDom.error) {
      buffer.appendBuffer(latestBufferData.shift());
      if(!receivedFrames){
        receivedFrames = true;
	      document.getElementById('loadingWrapper').style.display = 'none';
	      document.getElementById('videoWrapper').style.display = 'flex';
      }
    }
  }
  function sourceBufferHandle(){
    buffer = mediaSource.addSourceBuffer(codecString);
    buffer.mode = 'sequence';
    buffer.addEventListener('updateend', function() {
      updateBuffer();
    });
  }
  mediaSource.addEventListener('sourceopen', sourceBufferHandle)
  var hasPlayed = false;
  function startThisThing() {
    document.getElementById('startWrapper').style.display = 'none';
    document.getElementById('loadingWrapper').style.display = 'flex';
    var socket = io();
    socket.on('clientCount', function(clientCount){
      document.getElementById('clientCount').innerText = clientCount;
    });
    socket.on('video', function(streamData){
      if (!hasPlayed) {
        hasPlayed = true;
        buffer.appendBuffer(streamData);
        videoDom.play();
      }else {
        latestBufferData.push(streamData)
        updateBuffer();
      }
    });
    setInterval(function(){
      // make sure we don't get too far out of real time.
      latestBufferData = []
    }, 3000)
  }
</script>
</body>
</html>
